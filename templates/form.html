<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>UniFleet â€“ Vouchers</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            padding: 30px;
        }

        h1 {
            color: #004080;
            margin-bottom: 0.2rem;
        }

        .subnav {
            margin-bottom: 1.8rem;
            font-size: 0.95rem;
        }

        .subnav a {
            margin-right: 1.2rem;
            text-decoration: none;
            color: #0054a6;
            font-weight: 600;
        }

        .subnav a:hover {
            text-decoration: underline;
        }

        h2 {
            color: #333;
            margin-top: 2rem;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #004080;
            color: white;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .download-icon {
            text-decoration: none;
            font-weight: bold;
            color: #004080;
        }

        .download-icon:hover {
            text-decoration: underline;
        }

        .delete-button {
            background-color: #d9534f;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-button[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .verify-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        .verify-button:hover {
            filter: brightness(0.95);
        }

        td form {
            display: inline-block;
            margin: 0;
            padding: 0;
            line-height: 1;
            vertical-align: middle;
        }

        /* Collapsible panel */
        .panel {
          background: #fff;
          border-radius: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.08);
          padding: 0 0 10px 0;
          margin-bottom: 24px;
          border: 1px solid #e9eef5;
        }
        .panel > summary {
          cursor: pointer;
          list-style: none;
          padding: 16px 18px;
          font-size: 1.2rem;
          font-weight: 700;
          color: #233b64;
          border-bottom: 1px solid #f0f3f8;

          /* show a caret and align like a header */
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .panel .caret {
          font-weight: 700;
          color: #8aa0c2;
          transition: transform 0.15s ease;
        }
        .panel[open] .caret { transform: rotate(180deg); }

        .panel > summary::-webkit-details-marker { display: none; }

        /* Constrain panel inner width and center it */
        .panel .panel-controls,
        .panel .station-grid,
        .panel .panel-actions {
          max-width: 900px;
          margin: 0 auto;
        }

        .panel-controls {
          display: flex;
          gap: 10px;
          align-items: center;
          padding: 12px 18px 0 18px;
          color: #506080;
          font-size: 0.9rem;
        }
        .panel-controls .linklike {
          background: none;
          border: none;
          color: #0054a6;
          cursor: pointer;
          padding: 0;
          font: inherit;
        }
        .panel-controls .linklike:hover { text-decoration: underline; }
        .panel-controls .sep { color: #9aa7bd; }

        /* >>> SINGLE compact station-grid rule (removed earlier duplicate) */
        .station-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
          gap: 8px 12px;
          padding: 12px 18px 6px 18px;
          max-height: 320px;      /* more compact */
          overflow: auto;
        }
        .station-pill {
          display: flex;
          align-items: center;
          gap: 8px;
          background: #f7f9fc;
          border: 1px solid #e6edf6;
          border-radius: 999px;
          padding: 6px 10px;      /* smaller pill */
          cursor: pointer;
          user-select: none;
          transition: background .15s ease;
          font-size: 0.9rem;      /* smaller text */
        }
        .station-pill:hover { background: #eef4fb; }
        .station-pill input[type="checkbox"] {
          width: 14px; height: 14px; /* smaller checkbox */
        }

        .station-pill-text {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          max-width: 100%;
          color: #334e7b;
        }

        .panel-actions {
          display: flex;
          gap: 12px;
          padding: 8px 18px 10px 18px;
        }

        .btn-primary {
          background-color: #0b4a94;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 10px 16px;
          font-weight: 600;
          cursor: pointer;
        }
        .btn-primary:hover { filter: brightness(0.96); }

        .btn-secondary {
          display: inline-block;
          background-color: #f6f8fb;
          color: #0b4a94;
          border: 1px solid #d8e2f0;
          border-radius: 6px;
          padding: 10px 16px;
          font-weight: 600;
          text-decoration: none;
        }
        .btn-secondary:hover { background: #eef3f9; }
    </style>
</head>
<body>

    <h1>UniFleet Vouchers Dashboard</h1>
    <div class="subnav">
        <a href="/register" target="_blank">Register</a>
        <a href="/book" target="_blank">Book</a>
        <a href="/export_supplier_csv" download>Download Supplier CSV</a>
        <a href="/admin/prices?key=unifleet-admin" target="_blank">Admin Prices</a>


    </div>

    <!-- Supplier PDF filter + actions (persist via cookie) -->
    <!-- NOTE: removed `open` so it's collapsed by default -->
    <details class="panel">
      <summary>Supplier PDF <span class="caret">â–¾</span></summary>

      <!-- Compact controls row -->
      <div class="panel-controls">
        <button type="button" class="linklike" id="selectAllStations">Select all</button>
        <span class="sep">â€¢</span>
        <button type="button" class="linklike" id="clearAllStations">Clear all</button>
      </div>

      <!-- Station picker (posts cookie of selected station ids) -->
      <form action="/pdf/prefs" method="POST" id="pdfPrefsForm">
        {% set default_all = (selected_station_ids|length == 0) %}

        <div class="station-grid">
          {% for s in station_options %}
            <label class="station-pill">
              <input
                type="checkbox"
                name="station_id"
                value="{{ s.get('id') }}"
                {% if default_all or (s.get('id') in selected_station_ids) %}checked{% endif %}
              />

              <span class="station-pill-text">
                {{ (s.get('brand') or '') }} â€” {{ (s.get('name') or '') }}
              </span>
            </label>
          {% endfor %}
        </div>

        <div class="panel-actions">
          <button type="submit" class="btn-primary">Save Selection</button>
          <button type="button" class="btn-secondary" id="exportSupplierPdf">Download Supplier PDF</button>
        </div>

      </form>
    </details>

    <h2>All Vouchers</h2>
    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search vouchers..." style="margin-bottom: 15px; padding: 8px; width: 100%; max-width: 400px;">

    <table>
        <thead>
          <tr>
            <th>Voucher ID</th>
            <th>Driver</th>
            <th>Station</th>
            <th>Refuel Date</th>
            <th>Status</th>
            <th>Verify</th>
            <th>Price (â‚±/L)</th>
            <th>Discount (â‚±/L)</th>
            <th>Requested (â‚±)</th>
            <th>Total</th>
            <th>PNG</th>
            <th>Delete PNGs</th>
          </tr>
        </thead>

        <tbody>
            {% for row in vouchers %}
            <tr>
                <td><a href="/redeem/{{ row['voucher_id'] }}" target="_blank">{{ row['voucher_id'] }}</a></td>
                <td>{{ row['driver_name'] }}</td>
                <td>{{ row['station'] }}</td>
                <td>
                  {% set ts = row.get('refuel_datetime') or row.get('expected_refill_date') or row.get('transaction_date') %}
                  {{ ts|manila_time }}
                </td>
                <td>{{ row['status'] }}</td>

                <td>
                  {% if row['status'] == 'Unverified' %}
                    <a
                      class="verify-button"
                      href="/ops/voucher/{{ row['voucher_id'] }}/status/Unredeemed?next={{ url_for('form') }}{% if ops_token %}&token={{ ops_token }}{% endif %}">
                      Verify
                    </a>
                  {% else %}
                    <span style="color:#777;">â€”</span>
                  {% endif %}
                </td>

                {% set _price = row.get('price_snapshot_php_per_liter') or row.get('live_price_php_per_liter') %}
                <td style="white-space:nowrap;">
                  {% if _price not in (None, '', 'nan') %}
                    â‚±{{ '%.2f'|format(_price) }}/L
                  {% else %}
                    â€”
                  {% endif %}
                </td>

                {% set _disc = row.get('discount_snapshot_php_per_liter') or row.get('discount_per_liter') %}
                <td style="white-space:nowrap;">
                  {% if _disc not in (None, '', 'nan') %}
                    â‚±{{ '%.2f'|format(_disc) }}/L
                  {% else %}
                    â€”
                  {% endif %}
                </td>

                {% set _req = row.get('requested_amount_php') %}
                <td style="white-space:nowrap;">
                  {% if _req not in (None, '', 'nan') %}
                    â‚±{{ '{:,.2f}'.format(_req|float) }}
                  {% else %}
                    â€”
                  {% endif %}
                </td>

                {% set _total = row.get('total_dispensed') or row.get('total_dispensed_php') %}
                <td style="white-space:nowrap;">
                  {% if _total not in (None, '', 'nan') %}
                    â‚±{{ '{:,.2f}'.format(_total|float) }}
                  {% else %}
                    â€”
                  {% endif %}
                </td>

                <td>
                    <a class="download-icon" href="/static/qr_codes/{{ row['voucher_id'] }}_Official.png" download>ðŸ“¥</a>
                </td>
                <td>
                    {% if row.png_exists %}
                        <form method="POST" action="/delete_png/{{ row['voucher_id'] }}" onsubmit="return confirm('Delete both PNGs for {{ row['voucher_id'] }}?');">
                            <button type="submit" class="delete-button">Delete</button>
                        </form>
                    {% else %}
                        <button class="delete-button" disabled>Deleted</button>
                    {% endif %}
                </td>
            </tr>

            {% endfor %}
        </tbody>
    </table>

    <script>
        function filterTable() {
            const input = document.getElementById("searchInput").value.toLowerCase();
            const rows = document.querySelectorAll("tbody tr");
            rows.forEach(row => {
                const rowText = row.innerText.toLowerCase();
                row.style.display = rowText.includes(input) ? "" : "none";
            });
        }

        // Supplier PDF: select/clear helpers
        (function () {
          const form = document.getElementById("pdfPrefsForm");
          if (!form) return;

          const selectAllBtn = document.getElementById("selectAllStations");
          const clearAllBtn  = document.getElementById("clearAllStations");

          function setAll(checked) {
            form.querySelectorAll('input[type="checkbox"][name="station_id"]').forEach(cb => {
              cb.checked = checked;
            });
          }

          if (selectAllBtn) selectAllBtn.addEventListener("click", () => setAll(true));
          if (clearAllBtn)  clearAllBtn.addEventListener("click", () => setAll(false));
        })();
    </script>

  <script>
    (function () {
      const exportBtn = document.getElementById('exportSupplierPdf');
      const form = document.getElementById('pdfPrefsForm');
      if (!exportBtn || !form) return;

      exportBtn.addEventListener('click', () => {
        const ids = Array.from(
          form.querySelectorAll('input[type="checkbox"][name="station_id"]:checked')
        ).map(cb => cb.value);
        const qs = ids.length
          ? ('?' + ids.map(id => 'station=' + encodeURIComponent(id)).join('&'))
          : '';
        window.location.href = '/supplier-sheet.pdf' + qs;
      });
    })();
  </script>


</body>
</html>
